---
title: "Examining the Evidence for a Sixth Mass Extinction"
author: "Maeve Gilbert, Russell Huang"
maketitle: true
output: github_document
---

```{r include=FALSE}
library("tidyverse")
library("httr")
library("jsonlite")
library("glue")
#library("printr")
library("ggplot2")
knitr::opts_chunk$set(comment=NA)
```

In order to examine extinction data, we need to download the IUCN Red List historical data on species extintions. This data can be found in the following file, as our own attempt to call the URL caused the database to crash. This file allows us to quickly access the data from an external source (in this case a github page) rather than attempting to access it every time we ran our code. 
```{r}
download.file("https://github.com/espm-157/extinction-template/releases/download/data2.0/extinction-data.zip", "extinction-data.zip")
unzip("extinction-data.zip")
```

This chunk uses the REST API information from the IUCN website. This code breaks the URL of the data into pieces that can be read by the computer. This API call uses a universal base used by all of the different calls. In this case, we only want to look at the total number of species in the database, so our endpoint is "species count". We are using a public token (query) to access the data. 
```{r}
base <- "https://apiv3.iucnredlist.org/api/v3"
endpoint <- "speciescount"
token <- "9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee"
url<- (glue("{base}/{endpoint}?token={token}"))

req <- GET(url)
x <- content(req)
x$speciescount

#https://apiv3.iucnredlist.org/api/v3/species/page/0?token=9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee
```

```{r}
species_endpoint <- "species"
page <- paste0("page/", 0:15)
all_pages<- glue ("{base}/{species_endpoint}/{page}?token={token}")


```

Apply GET function to object all_pages (functional programming).
```{r}
if(!file.exists("all_species.rds")){
all_species<-map(all_pages, GET)
map(all_species, stop_for_status)
write_rds(all_species, "all_species.rds")
}

```

```{r}
all_species_rds<-read_rds("all_species.rds")

#codes<-map_int(all_species, status_code)
#stopifnot(all(codes<400))
```



```{r}
all_resp<- map(all_species_rds, content, encoding="UTF-8")

```

Calling the relevant information needed to describe extinct species. Scientific name, category (extinct) and class. 
```{r}
sci_name_list<-map(all_resp, \(page) map_chr(page$result, "scientific_name"))|> list_c()

#x<-unlist(sci_name)
```

```{r}

category<- map(all_resp, \(page) map_chr(page$result, "category"))|> list_c()



```

```{r}
class<-map(all_resp, \(page) map_chr(page$result, "class_name"))|> list_c()


```

```{r}
if(!file.exists("ex_narrative.rds")){
  ex_narrative<- map(ex_urls, GET)
  map(ex_narrative, stop_for_status, .progress=TRUE)
  write_rds(ex_narrative, "ex_narrative.rds")
}

ex_narrative<-read_rds("ex_narrative.rds")
```


```{r}
narrative_contents<- map(ex_narrative, content)

narrative_population<-map(narrative_contents, \(content)     map_chr(content$result[1], "population", .default=""))


head(narrative_population, 20)

narrative_rationale<-map(narrative_contents, \(content) content$result[[1]]$rationale)

head(narrative_rationale, 20)

#stringr::str_extract(txt, "\\d{4}")
```

```{r}
extinct_species<- 
  all_species|> 
  filter(category=="EX")
head(extinct_species)

```

```{r}
sci_name<- extinct_species$sci_name
ex_urls<- glue("{base}/species/narrative/{sci_name}?token={token}")|>
  URLencode()
ex_urls[[1]]
GET(ex_urls[[1]])

```

```{r}
#dates<-narrative_rationale[1:20] |> map(str_extract, "\\d{4}")

last_seen<-narrative_population |> 
  map_chr(str_extract, "\\d{4}")|> 
  as.integer()
  
#last_century<-narrative_population |> 
#  map_chr(str_extract, "\\d{2}th")|> 
 # as.character()

gone<-tibble(sci_name, last_seen)|>
  distinct()
head(gone)
count(gone)

```


```{r}
extinct_species<- 
  all_species|> 
  filter(category=="EX")
head(extinct_species)

```


Joining these lists together and making all_species lists into a tibble
```{r}
#x|> count(category)
all_species<- tibble(sci_name=sci_name_list, category, class)

combined<-dplyr::left_join(all_species, gone)

total_sp<-combined|>
  filter(class%in% c("MAMMALIA", "AVES", "AMPHIBIA", "REPTILIA", "ACTINOPTERYGII"))|>
  count(class, name="total")

#filtered by extinctions by class and counts number of extinctions per century
cumulative<-combined|>
  filter(category=="EX")|>
  filter(class%in% c("MAMMALIA", "AVES", "AMPHIBIA", "REPTILIA", "ACTINOPTERYGII"))|>
  mutate(last_seen= replace_na(last_seen, 2023), century= str_extract(last_seen, "\\d{2}"))|>
  count(century, class)|>
  left_join(total_sp)|>
  group_by(class)|>
  mutate(percent_extinct=((n/total)*100))|>
  mutate(cumulative_extinct=(cumsum(n))) |>
  mutate(percent_cumulative_extinct=((cumulative_extinct/total)*100)) 
cumulative
#divide number of extinctions per class per year by total number of species per class, multiply by a million (?), divide by 100 to get a percentage
#could try making this table by filtering total_sp table and not joining it to the combined table 
#plot percentages by century??
```
```{r}
extinctions_plot<- cumulative|>
  ggplot()+
  geom_line(aes(x=century, y=percent_cumulative_extinct, color=class, group=class))+
  ggtitle("Cumulative Species Extinctions")+
  xlab("Century")+
  ylab("Percent of Species Extinct")
extinctions_plot

  
```



```{r}
#Tester tables to look at extinction dates for different classes  
birds<-combined|>
  filter(class=="AVES", category=="EX")|>
  mutate(last_seen= replace_na(last_seen, 2023))
unique(birds$last_seen)

amphibians<- combined|>
  filter(class=="AMPHIBIA", category=="EX")|>
  mutate(last_seen= tidyr::replace_na(last_seen, 2023))
head(amphibians, 20)


#final table should include extinctions by year, cumulative extinctions up to and including each year, and percentage of total species that are extinct by year
```

## Extinctions Module

_Are we experiencing the sixth great extinction?_  

What is the current pace of extinction? Is it accelerating? How does it compare to background extinction rates?

Background extinctions rate is one species per million years. 

## Background

- [Section Intro Video](https://youtu.be/QsH6ytm89GI)
- [Ceballos et al (2015)](http://doi.org/10.1126/sciadv.1400253)

Our focal task will be to reproduce the result from Ceballos and colleagues showing the recent increase in extinction rates relative to the background rate:

![](https://espm-157.carlboettiger.info/img/extinctions.jpg)


## Computational Topics

- Accessing data from a RESTful API
- Error handling
- JSON data format
- Regular expressions
- Working with missing values

## Additional references:

- http://www.hhmi.org/biointeractive/biodiversity-age-humans (Video)
- [Barnosky et al. (2011)](http://doi.org/10.1038/nature09678)
- [Pimm et al (2014)](http://doi.org/10.1126/science.1246752)
- [Sandom et al (2014)](http://dx.doi.org/10.1098/rspb.2013.3254)




