---
title: "Extinctions Unit"
author: "Maeve Gilbert, Russell Huang"
maketitle: true
output: github_document
---



```{r include=FALSE}
library("tidyverse")
library("httr")
library("jsonlite")
library("glue")
#library("printr")
knitr::opts_chunk$set(comment=NA)
```


```{r}
download.file("https://github.com/espm-157/extinction-template/releases/download/data2.0/extinction-data.zip", "extinction-data.zip")
unzip("extinction-data.zip")
```


```{r}
base <- "https://apiv3.iucnredlist.org/api/v3"
endpoint <- "speciescount"
token <- "9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee"
url<- (glue("{base}/{endpoint}?token={token}"))

req <- GET(url)
x <- content(req)
x$speciescount

#https://apiv3.iucnredlist.org/api/v3/species/page/0?token=9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee
```

```{r}
species_endpoint <- "species"
page <- paste0("page/", 0:15)
all_pages<- glue ("{base}/{species_endpoint}/{page}?token={token}")


```

Apply GET function to object all_pages (functional programming).
```{r}
if(!file.exists("all_species.rds")){
all_species<-map(all_pages, GET)
map(all_species, stop_for_status)
write_rds(all_species, "all_species.rds")
}

```

```{r}
all_species<-read_rds("all_species.rds")

#codes<-map_int(all_species, status_code)
#stopifnot(all(codes<400))
```



```{r}
all_resp<- map(all_species, content, encoding="UTF-8")

```

```{r}
sci_name<-map(all_resp, \(page) map_chr(page$result, "scientific_name"))|> list_c()

x<-unlist(sci_name)
```


```{r}

category<- map(all_resp, \(page) map_chr(page$result, "category"))|> list_c()



```

```{r}
class<-map(all_resp, \(page) map_chr(page$result, "class_name"))|> list_c()


```



```{r}
x<-tibble(sci_name, category, class)
#x|> count(category)
#all_species<- tibble(sci_name, category)
```



```{r}
extinct_species<- 
  all_species|> 
  filter(category=="EX")
head(extinct_species)


```


```{r}
sp<- extinct_species$sci_name
ex_urls<- glue("{base}/species/narrative/{sp}?token={token}")|>
  URLencode()
ex_urls[[1]]
GET(ex_urls[[1]])

```
```{r}
if(!file.exists("ex_narrative.rds")){
  ex_narrative<- map(ex_urls, GET)
  map(ex_narrative, stop_for_status, .progress=TRUE)
  write_rds(ex_narrative, "ex_narrative.rds")
}

ex_narrative<-read_rds("ex_narrative.rds")
```


```{r}
narrative_contents<- map(ex_narrative, content)

narrative_population<-map(narrative_contents, \(content)    map_chr(content$result[1], "population", .default=""))


head(narrative_population, 20)

narrative_rationale<-map(narrative_contents, \(content) content$result[[1]]$rationale)

head(narrative_rationale, 20)

#stringr::str_extract(txt, "\\d{4}")
```


```{r}
#dates<-narrative_rationale[1:20] |> map(str_extract, "\\d{4}")

last_seen<-narrative_population |> 
  map_chr(str_extract, "\\d{4}")|> 
  as.integer()
  

gone<-tibble(sci_name=sp, last_seen)|>
  distinct()
head(gone)

all_data<-x|>
  filter(category=="EX")|>
  left_join(gone)
head(all_data)

#join gone table with all_data table by species name. sp=species_name
#how to join by and rename these 
```

## Extinctions Module

_Are we experiencing the sixth great extinction?_  

What is the current pace of extinction? Is it accelerating? How does it compare to background extinction rates?

## Background

- [Section Intro Video](https://youtu.be/QsH6ytm89GI)
- [Ceballos et al (2015)](http://doi.org/10.1126/sciadv.1400253)

Our focal task will be to reproduce the result from Ceballos and colleagues showing the recent increase in extinction rates relative to the background rate:

![](https://espm-157.carlboettiger.info/img/extinctions.jpg)


## Computational Topics

- Accessing data from a RESTful API
- Error handling
- JSON data format
- Regular expressions
- Working with missing values

## Additional references:

- http://www.hhmi.org/biointeractive/biodiversity-age-humans (Video)
- [Barnosky et al. (2011)](http://doi.org/10.1038/nature09678)
- [Pimm et al (2014)](http://doi.org/10.1126/science.1246752)
- [Sandom et al (2014)](http://dx.doi.org/10.1098/rspb.2013.3254)




